<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fleet Tracker - Trip Management Flow</title>
    <script src="https://cdn.jsdelivr.net/npm/mermaid@10.6.1/dist/mermaid.min.js"></script>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            padding: 30px;
        }
        h1 {
            color: #2c3e50;
            text-align: center;
            margin-bottom: 10px;
        }
        .subtitle {
            color: #7f8c8d;
            text-align: center;
            margin-bottom: 30px;
            font-size: 1.1em;
        }
        .diagram-container {
            width: 100%;
            height: auto;
            margin: 20px 0;
        }
        .description {
            background-color: #f8f9fa;
            border-left: 4px solid #17a2b8;
            padding: 15px;
            margin: 20px 0;
            border-radius: 4px;
        }
        .description h3 {
            margin-top: 0;
            color: #495057;
        }
        .journey-stages {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 20px;
            margin-top: 30px;
        }
        .stage-item {
            background: #fff;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 15px;
            position: relative;
        }
        .stage-item h4 {
            color: #495057;
            margin-top: 0;
        }
        .login-stage {
            border-left: 4px solid #007bff;
        }
        .vehicle-stage {
            border-left: 4px solid #28a745;
        }
        .trip-stage {
            border-left: 4px solid #ffc107;
        }
        .sync-stage {
            border-left: 4px solid #6f42c1;
        }
        .flow-step {
            background-color: #e9ecef;
            border-radius: 4px;
            padding: 8px 12px;
            margin: 5px 0;
            font-size: 0.9em;
        }
        .online-flow {
            background-color: #d1ecf1;
            border: 1px solid #bee5eb;
        }
        .offline-flow {
            background-color: #fff3cd;
            border: 1px solid #ffeaa7;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üöÄ Trip Management Flow</h1>
        <p class="subtitle">Complete user journey from login to trip completion with online/offline handling</p>
        
        <div class="description">
            <h3>Trip Management Overview</h3>
            <p>This flowchart shows the complete user journey through the Fleet Tracker application, from initial login to trip completion. It demonstrates how the system handles both online and offline scenarios seamlessly, ensuring users can always start and end trips regardless of connectivity.</p>
        </div>

        <div class="diagram-container">
            <div class="mermaid">
flowchart TD
    START[User Wants to Start Trip] --> LOGIN_CHECK{User<br/>Logged In?}
    LOGIN_CHECK -->|No| LOGIN[Login Page<br/>Enter CoynoId]
    LOGIN_CHECK -->|Yes| DEPT_CHECK{Department<br/>Selected?}
    
    LOGIN --> USER_AUTH[ApiRouter.getUserProfile]
    USER_AUTH --> SAVE_USER[Save User to<br/>TripContext & localStorage]
    SAVE_USER --> DEPT_CHECK
    
    DEPT_CHECK -->|No| DEPT_SELECT[Select Department<br/>DepartmentSwitcher]
    DEPT_CHECK -->|Yes| VEHICLE_PAGE[Navigate to<br/>Vehicles Page]
    
    DEPT_SELECT --> UPDATE_DEPT[Update userDepartment<br/>in TripContext]
    UPDATE_DEPT --> VEHICLE_PAGE
    
    VEHICLE_PAGE --> LOAD_VEHICLES[ApiRouter.getVehicles<br/>for Department]
    LOAD_VEHICLES --> ONLINE_CHECK{Network<br/>Online?}
    
    %% Online Vehicle Loading
    ONLINE_CHECK -->|Yes| FETCH_FRESH[OnlineApi<br/>Fetch Fresh Vehicles]
    FETCH_FRESH --> CACHE_VEHICLES[Cache in<br/>OfflineStorage]
    CACHE_VEHICLES --> DISPLAY_VEHICLES[Display Vehicle List<br/>with Status]
    
    %% Offline Vehicle Loading  
    ONLINE_CHECK -->|No| LOAD_CACHED[OfflineOnlyApi<br/>Load Cached Vehicles]
    LOAD_CACHED --> CHECK_CACHE{Vehicles in<br/>Cache?}
    CHECK_CACHE -->|Yes| DISPLAY_VEHICLES
    CHECK_CACHE -->|No| NO_VEHICLES[Show No Vehicles<br/>Available Offline]
    
    DISPLAY_VEHICLES --> USER_SELECT[User Selects Vehicle]
    USER_SELECT --> STATUS_CHECK{Vehicle<br/>Available?}
    
    STATUS_CHECK -->|No| CONFLICT[Show Vehicle<br/>Unavailable Message]
    STATUS_CHECK -->|Yes| START_TRIP_PAGE[Navigate to<br/>StartTrip Page]
    
    START_TRIP_PAGE --> TRIP_FORM[Fill Trip Details:<br/>Purpose, Location]
    TRIP_FORM --> INSPECTION[Vehicle Inspection<br/>Optional]
    
    INSPECTION --> CREATE_TRIP[ApiRouter.startTrip]
    CREATE_TRIP --> TRIP_ONLINE_CHECK{Network<br/>Online?}
    
    %% Online Trip Creation
    TRIP_ONLINE_CHECK -->|Yes| ONLINE_TRIP[OnlineApi<br/>Create Trip on Server]
    ONLINE_TRIP --> TRIP_SUCCESS{Trip Created<br/>Successfully?}
    TRIP_SUCCESS -->|Yes| UPDATE_VEHICLE[Update Vehicle Status<br/>to in-use]
    TRIP_SUCCESS -->|No| TRIP_ERROR[Show Error<br/>Try Again]
    
    %% Offline Trip Creation
    TRIP_ONLINE_CHECK -->|No| OFFLINE_TRIP[OfflineOnlyApi<br/>Create Local Trip]
    OFFLINE_TRIP --> GENERATE_ID[Generate Offline<br/>Trip ID]
    GENERATE_ID --> SAVE_LOCAL[Save to IndexedDB<br/>synced: false]
    SAVE_LOCAL --> QUEUE_SYNC[Add to Sync Queue<br/>for Later Upload]
    
    %% Trip Active State
    UPDATE_VEHICLE --> ACTIVE_TRIP[Trip Active<br/>TripContext.currentTrip]
    QUEUE_SYNC --> ACTIVE_TRIP
    
    ACTIVE_TRIP --> HOME_PAGE[Navigate to Home<br/>Show Active Trip]
    HOME_PAGE --> TRIP_MONITOR[Monitor Trip:<br/>Duration, Location]
    
    %% End Trip Flow
    TRIP_MONITOR --> END_REQUEST[User Clicks<br/>End Trip]
    END_REQUEST --> END_TRIP_PAGE[Navigate to<br/>EndTrip Page]
    
    END_TRIP_PAGE --> END_FORM[Fill End Details:<br/>Location, Odometer, Damage]
    END_FORM --> END_INSPECTION[Post-Trip Inspection<br/>Optional]
    
    END_INSPECTION --> COMPLETE_TRIP[ApiRouter.endTrip]
    COMPLETE_TRIP --> END_ONLINE_CHECK{Network<br/>Online?}
    
    %% Online Trip Completion
    END_ONLINE_CHECK -->|Yes| ONLINE_END[OnlineApi<br/>Complete Trip on Server]
    ONLINE_END --> END_SUCCESS{Trip Completed<br/>Successfully?}
    END_SUCCESS -->|Yes| FREE_VEHICLE[Update Vehicle Status<br/>to available]
    END_SUCCESS -->|No| END_ERROR[Show Error<br/>Try Again]
    
    %% Offline Trip Completion
    END_ONLINE_CHECK -->|No| OFFLINE_END[OfflineOnlyApi<br/>Complete Local Trip]
    OFFLINE_END --> UPDATE_LOCAL[Update Trip in IndexedDB<br/>status: completed]
    UPDATE_LOCAL --> QUEUE_END_SYNC[Add to Sync Queue<br/>for Later Upload]
    
    %% Final State
    FREE_VEHICLE --> TRIP_HISTORY[Add to Trip History<br/>Clear currentTrip]
    QUEUE_END_SYNC --> TRIP_HISTORY
    
    TRIP_HISTORY --> NOTIFICATIONS[Send Push Notification<br/>Trip Completed]
    NOTIFICATIONS --> HOME_RETURN[Return to Home<br/>Show Statistics]
            </div>
        </div>

        <div class="journey-stages">
            <div class="stage-item login-stage">
                <h4>üîê Authentication Stage</h4>
                <p><strong>User Login Process</strong>:</p>
                <div class="flow-step">Enter CoynoId credential</div>
                <div class="flow-step">ApiRouter.getUserProfile call</div>
                <div class="flow-step">Save user to TripContext</div>
                <div class="flow-step">Store in localStorage</div>
                <p><strong>Department Selection</strong>:</p>
                <div class="flow-step">DepartmentSwitcher component</div>
                <div class="flow-step">Update TripContext state</div>
            </div>
            
            <div class="stage-item vehicle-stage">
                <h4>üöó Vehicle Selection Stage</h4>
                <p><strong>Online Vehicle Loading</strong>:</p>
                <div class="flow-step online-flow">OnlineApi fetches fresh vehicles</div>
                <div class="flow-step online-flow">Cache in OfflineStorage</div>
                <div class="flow-step online-flow">Display with real-time status</div>
                
                <p><strong>Offline Vehicle Loading</strong>:</p>
                <div class="flow-step offline-flow">Load from IndexedDB cache</div>
                <div class="flow-step offline-flow">Check cache validity</div>
                <div class="flow-step offline-flow">Show available cached vehicles</div>
            </div>
            
            <div class="stage-item trip-stage">
                <h4>üõ£Ô∏è Trip Lifecycle Stage</h4>
                <p><strong>Trip Creation</strong>:</p>
                <div class="flow-step">Fill trip details and purpose</div>
                <div class="flow-step">Optional vehicle inspection</div>
                <div class="flow-step">ApiRouter.startTrip call</div>
                
                <p><strong>Online Trip Creation</strong>:</p>
                <div class="flow-step online-flow">OnlineApi creates on server</div>
                <div class="flow-step online-flow">Update vehicle status</div>
                <div class="flow-step online-flow">Send push notification</div>
                
                <p><strong>Offline Trip Creation</strong>:</p>
                <div class="flow-step offline-flow">Generate offline trip ID</div>
                <div class="flow-step offline-flow">Save to IndexedDB</div>
                <div class="flow-step offline-flow">Queue for sync</div>
            </div>
            
            <div class="stage-item trip-stage">
                <h4>‚è±Ô∏è Active Trip Monitoring</h4>
                <p><strong>Trip Monitoring</strong>:</p>
                <div class="flow-step">TripContext.currentTrip state</div>
                <div class="flow-step">Real-time duration tracking</div>
                <div class="flow-step">Location monitoring</div>
                <div class="flow-step">Trip reminder notifications</div>
                
                <p><strong>Trip Completion</strong>:</p>
                <div class="flow-step">Fill end location and details</div>
                <div class="flow-step">Optional post-trip inspection</div>
                <div class="flow-step">ApiRouter.endTrip call</div>
            </div>
            
            <div class="stage-item sync-stage">
                <h4>üîÑ Background Sync Stage</h4>
                <p><strong>When Network Returns</strong>:</p>
                <div class="flow-step">BackgroundSync triggers</div>
                <div class="flow-step">Process sync queue</div>
                <div class="flow-step">Upload offline trips</div>
                <div class="flow-step">Reconcile with server</div>
                
                <p><strong>Conflict Resolution</strong>:</p>
                <div class="flow-step">Server data takes precedence</div>
                <div class="flow-step">Update local cache</div>
                <div class="flow-step">Notify user of changes</div>
            </div>
            
            <div class="stage-item login-stage">
                <h4>üìä State Management</h4>
                <p><strong>TripContext Integration</strong>:</p>
                <div class="flow-step">currentTrip state</div>
                <div class="flow-step">tripHistory array</div>
                <div class="flow-step">vehicles list</div>
                <div class="flow-step">userDepartment</div>
                
                <p><strong>Persistence</strong>:</p>
                <div class="flow-step">localStorage backup</div>
                <div class="flow-step">IndexedDB offline storage</div>
                <div class="flow-step">Context rehydration</div>
            </div>
        </div>

        <div class="description">
            <h3>üéØ Key Flow Benefits</h3>
            <ul>
                <li><strong>üîÑ Seamless Experience</strong>: Users see identical functionality whether online or offline</li>
                <li><strong>üíæ Data Persistence</strong>: Trips are never lost due to connectivity issues</li>
                <li><strong>‚ö° Real-time Updates</strong>: Vehicle status prevents conflicts between users</li>
                <li><strong>üîí Secure Authentication</strong>: CoynoId-based login with session management</li>
                <li><strong>üì± Context-Aware</strong>: TripContext maintains state across navigation</li>
                <li><strong>üîî Smart Notifications</strong>: Push notifications and reminders enhance UX</li>
                <li><strong>üõ°Ô∏è Error Recovery</strong>: Graceful error handling and retry logic</li>
            </ul>
        </div>
    </div>

    <script>
        mermaid.initialize({
            startOnLoad: true,
            theme: 'default',
            flowchart: {
                useMaxWidth: true,
                htmlLabels: true,
                curve: 'basis'
            }
        });
    </script>
</body>
</html> 